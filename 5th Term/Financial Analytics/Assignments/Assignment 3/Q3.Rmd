---
title: "Q3"
author: "Qian Zhang"
date: "2021年5月24日"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("readxl")
library(MASS)
library(rockchalk)
```


```{r cars}
ER_and_SD <- read_excel("Return-Covariance-Data.xlsx", sheet = "ER and SD")
Covariance_matrix <- read_excel("Return-Covariance-Data.xlsx", sheet = "Covariance matrix")
true_mu = ER_and_SD$'Expected Return (%)'
true_sigma = data.matrix(Covariance_matrix[,-1])
```


```{r pressure, echo=FALSE}
set.seed(10)
monthly_return = mvrnorm(n = 60, true_mu, true_sigma, tol = 1e-06, empirical = FALSE)
```

Q(a). Compute the sample mean and the sample covariance matrix of the returns you generated.
```{r}
sample_mu = colMeans(monthly_return)
sample_Sigma = cov(monthly_return)
```


Q(b). Compute at least ten long-only effcient portfolios along the effcient frontier based on the estimates in part (a).
```{r}
SAMPLES <- 100
n <- 8
w <- Variable(n)
ret <- t(sample_mu) %*% w
risk <- quad_form(w, sample_Sigma)
constraints <- list(w >= 0, sum(w) == 1)

## Risk aversion parameters
gammas <- 10^seq(-2, 3, length.out = SAMPLES)
ret_data <- rep(0, SAMPLES)
risk_data <- rep(0, SAMPLES)
w_data <- matrix(0, nrow = SAMPLES, ncol = n)

## Compute trade-off curve
for(i in seq_along(gammas)) {
    gamma <- gammas[i]
    objective <- ret - gamma * risk
    prob <- Problem(Maximize(objective), constraints)
    result <- solve(prob)
    
    ## Evaluate risk/return for current solution
    risk_data[i] <- result$getValue(sqrt(risk))
    ret_data[i] <- result$getValue(ret)
    w_data[i,] <- result$getValue(w)
}
w_data_rounded <- round(w_data,2)
```


```{r}
index = round(seq(1, 100, length.out = 10))


portfolio <- data.frame(w_data_rounded,risk_data,ret_data)
names(portfolio)[1:8] <- names(Covariance_matrix)[-1]
names(portfolio)[9] <- 'estimate risk'
names(portfolio)[10] <- 'estimate return'
```


Q(c).Compute the actual expected returns and standard deviations for the portfolios found in step (b).
```{r}


choosen_portfolio = portfolio[index,]
choosen_portfolio_weight = data.matrix(choosen_portfolio[0:8], rownames.force = NA)
actual_return = monthly_return%*%t(choosen_portfolio_weight)
actual_mu = colMeans(actual_return)
actual_sigma = cov(actual_return)

actual_variance = rep(0, 10)

for (i in seq_along(actual_variance)) {
  actual_variance[i] = t(choosen_portfolio_weight[i,])%*%true_sigma%*%choosen_portfolio_weight[i,]
}
```


Q(d).plot the estimated effcient frontier, the actual frontier, and the true frontier. 


Calculate the mean and standard deviation for true frontier
```{r}
n <- 8

## Form problem
w <- Variable(n)
ret <- t(true_mu) %*% w
risk <- quad_form(w, true_sigma)
constraints <- list(w >= 0, sum(w) == 1)

## Risk aversion parameters
gammas <- 10^seq(-2, 3, length.out = SAMPLES)
ret_data <- rep(0, SAMPLES)
risk_data <- rep(0, SAMPLES)
w_data <- matrix(0, nrow = SAMPLES, ncol = n)

## Compute trade-off curve
for(i in seq_along(gammas)) {
    gamma <- gammas[i]
    objective <- ret - gamma * risk
    prob <- Problem(Maximize(objective), constraints)
    result <- solve(prob)
    
    ## Evaluate risk/return for current solution
    risk_data[i] <- result$getValue(sqrt(risk))
    ret_data[i] <- result$getValue(ret)
    w_data[i,] <- result$getValue(w)
}
```



```{r}

ggplot() +
    geom_line(mapping = aes(x = choosen_portfolio$'estimate risk', y = choosen_portfolio$'estimate return',colour  = "Estimated Effcient Frontier") ) +
    geom_line(mapping = aes(x = risk_data, y = ret_data, color = "True Effcient Frontier")) +
    geom_line(mapping = aes(x = sqrt(actual_variance), y = actual_mu,colour  = "Actual Effcient Frontier") ) +
    xlab('Risk(Standard Deviation)') +
    ylab('Return')


```

